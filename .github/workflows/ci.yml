name: test

on:
  push:
    branches:
      - 'main'

jobs:
  test:
    runs-on: ubuntu-24.04-arm

    steps:
      # 1Ô∏è‚É£ Checkout the repo
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2Ô∏è‚É£ Log in to GitHub Container Registry (using PAT)
      - name: Log in to GHCR
        run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # 3Ô∏è‚É£ Pull the private container image
      - name: Pull container image
        run: docker pull ghcr.io/wp732/citool:latest

      # 4Ô∏è‚É£ Run trufflehog inside the container
      - name: Run repository secrets scan via trufflehog
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e HOME=/home/user \
            -e POETRY_VIRTUALENVS_PATH=/home/user/.cache/pypoetry/virtualenvs \
            ghcr.io/wp732/citool:latest \
            bin/run_trufflehog.sh
        env:
          THOG_LOG_LEVEL: ${{ vars.THOG_LOG_LEVEL }}

      # 5Ô∏è‚É£ Add missing import packages
      - name: Add missing import packages
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e HOME=/home/user \
            -e POETRY_VIRTUALENVS_PATH=/home/user/.cache/pypoetry/virtualenvs \
            ghcr.io/wp732/citool:latest \
            bin/add_missing_imports.sh

      # 6Ô∏è‚É£ Run SAST via bandit
      - name: Run SAST via bandit
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/wp732/citool:latest \
            bin/run_bandit.sh -f txt

      # 7Ô∏è‚É£ Run code formatting check via ruff
      - name: Run code formatting check via ruff
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/wp732/citool:latest \
            bin/run_ruff.sh --exclude tests/

      # 8Ô∏è‚É£ Run linting via pylint
      - name: Run linting via pylint
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/wp732/citool:latest \
            bin/run_pylint.sh --disable=C0114,C0115,C0116

      # 9Ô∏è‚É£ Run type checking via mypy
      - name: Run type checking via mypy
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/wp732/citool:latest \
            bin/run_mypy.sh

      # üîü Run unit tests via pytest
      - name: Run unit tests via pytest
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/wp732/citool:latest \
            bin/run_pytests.sh

      # 11Ô∏è‚É£ Run code coverage check
      - name: Run code coverage check
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/wp732/citool:latest \
            bin/run_coverage_tests.sh
