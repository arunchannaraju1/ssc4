name: test

on:
  push:
    branches:
      - 'main'

jobs:
  test:
    runs-on: ubuntu-24.04-arm

    steps:
      # 1️⃣ Log in to GHCR using PAT
      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # 2️⃣ Pull the private container image
      - name: Pull container image
        run: docker pull ghcr.io/wp732/citool:latest

      # 3️⃣ Run all steps inside the container
      - name: Run all steps inside container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e HOME=/home/user \
            -e POETRY_VIRTUALENVS_PATH=/home/user/.cache/pypoetry/virtualenvs \
            ghcr.io/wp732/citool:latest \
            /bin/bash -c "
              bin/run_trufflehog.sh &&
              bin/add_missing_imports.sh &&
              bin/run_bandit.sh -f txt &&
              bin/run_ruff.sh --exclude tests/ &&
              bin/run_pylint.sh --disable=C0114,C0115,C0116 &&
              bin/run_mypy.sh &&
              bin/run_pytests.sh &&
              bin/run_coverage_tests.sh
            "

      # 4️⃣ Checkout the repository (if needed outside container)
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
